name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create release package
        run: |
          cd custom_components
          zip -r ../ajax-hass.zip ajax/ \
            -x "ajax/__pycache__/*" \
            -x "ajax/**/__pycache__/*" \
            -x "ajax/**/*.pyc"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Ajax Integration v${{ steps.version.outputs.VERSION }}
          body: |
            ## What's Changed

            See the full changelog in [CHANGELOG.md](https://github.com/foXaCe/ajax-hass/blob/main/CHANGELOG.md)

            ## Installation via HACS

            1. Open HACS in Home Assistant
            2. Go to "Integrations"
            3. Find "Ajax Security System"
            4. Click "Update" to version ${{ steps.version.outputs.VERSION }}
            5. Restart Home Assistant

            ## Manual Installation

            1. Download the `ajax-hass.zip` file below
            2. Extract the `ajax` folder to your Home Assistant `custom_components` directory
            3. Restart Home Assistant
            4. Add the integration via Settings > Devices & Services > Add Integration > Ajax Security System

            ## Requirements

            - Home Assistant 2023.8.0 or newer
            - Ajax Systems account

            ---

            **Full Changelog**: https://github.com/foXaCe/ajax-hass/compare/${{ github.event.before }}...${{ github.sha }}
          files: ajax-hass.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
